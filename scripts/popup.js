(()=>{"use strict";class e{constructor(){this.screens=["welcomeScreen","createWalletScreen","importWalletScreen","walletScreen","sendScreen","receiveScreen"],this.setupToastContainer()}showScreen(e){console.log(`切换到屏幕: ${e}`),this.screens.forEach(e=>{const n=document.getElementById(e);n&&n.classList.add("hidden")});const n=document.getElementById(e);n?n.classList.remove("hidden"):console.error(`找不到屏幕: ${e}`)}updateAccountInfo(e,n){const t=`${e.substring(0,6)}...${e.substring(e.length-4)}`,s=document.getElementById("accountAddressShort");s&&(s.textContent=t);const o=document.getElementById("ethBalance");o&&(o.textContent=`${n} ETH`)}updateReceiveInfo(e){const n=document.getElementById("fullAddress");n&&(n.textContent=e),this.generateQRCode(e)}updateTokenList(e){const n=document.getElementById("tokenList");n&&(n.innerHTML="",0!==e.length?e.forEach(e=>{const t=document.createElement("div");t.className="token-item",t.innerHTML=`\n        <div class="token-info">\n          <div class="token-symbol">${e.symbol}</div>\n          <div class="token-name">${e.name}</div>\n        </div>\n        <div class="token-balance">${e.balance}</div>\n      `,n.appendChild(t)}):n.innerHTML='<div class="empty-message">暂无代币</div>')}showError(e){this.showToast(e,"error")}showSuccess(e){this.showToast(e,"success")}showMessage(e){this.showToast(e,"info")}showMnemonic(e){const n=document.createElement("div");n.className="modal",n.innerHTML=`\n      <div class="modal-content">\n        <h3>请备份您的助记词</h3>\n        <div class="mnemonic-container">${e}</div>\n        <p class="warning">警告：请将助记词保存在安全的地方，任何获得您助记词的人都能控制您的资产。</p>\n        <button id="mnemonicConfirmBtn" class="btn btn-primary">我已安全备份</button>\n      </div>\n    `,document.body.appendChild(n);const t=document.getElementById("mnemonicConfirmBtn");t&&t.addEventListener("click",()=>{document.body.removeChild(n),this.showScreen("walletScreen")})}generateQRCode(e){const n=document.getElementById("addressQRCode");n&&(n.innerHTML=`\n      <div style="width: 200px; height: 200px; background-color: #f0f0f0; display: flex; align-items: center; justify-content: center;">\n        <span>QR Code for:<br>${e.substring(0,10)}...${e.substring(e.length-6)}</span>\n      </div>\n    `)}setupToastContainer(){const e=document.createElement("div");e.id="toast-container",e.className="toast-container",document.body.appendChild(e);const n=document.createElement("style");n.textContent="\n      .toast-container {\n        position: fixed;\n        top: 20px;\n        right: 20px;\n        z-index: 9999;\n      }\n      \n      .toast {\n        padding: 12px 16px;\n        margin-bottom: 10px;\n        border-radius: 4px;\n        color: white;\n        box-shadow: 0 2px 5px rgba(0,0,0,0.2);\n        opacity: 0;\n        transform: translateY(-20px);\n        transition: all 0.3s ease;\n      }\n      \n      .toast.show {\n        opacity: 1;\n        transform: translateY(0);\n      }\n      \n      .toast.info {\n        background-color: rgba(79, 70, 229, 0.9) !important;\n      }\n      \n      .toast.success {\n        background-color: rgba(34, 197, 94, 0.9) !important;\n      }\n      \n      .toast.error {\n        background-color: rgba(239, 68, 68, 0.9) !important;\n      }\n      \n      .modal {\n        position: fixed;\n        top: 0;\n        left: 0;\n        width: 100%;\n        height: 100%;\n        background-color: rgba(80,80,80,0.95);\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        z-index: 1000;\n      }\n      \n      .modal-content {\n        background-color: white;\n        padding: 20px;\n        border-radius: 8px;\n        width: 80%;\n        max-width: 400px;\n      }\n      \n      .mnemonic-container {\n        background-color: #f5f5f5;\n        padding: 15px;\n        border-radius: 4px;\n        margin: 15px 0;\n        word-break: break-all;\n        font-family: monospace;\n        font-size: 16px;\n      }\n      \n      .warning {\n        color: var(--error-color);\n        font-size: 12px;\n        margin-bottom: 15px;\n      }\n    ",document.head.appendChild(n)}showToast(e,n){const t=document.getElementById("toast-container");if(!t)return;const s=document.createElement("div");s.className=`toast ${n}`,s.textContent=e,t.appendChild(s),setTimeout(()=>{s.classList.add("show")},10),setTimeout(()=>{s.classList.remove("show"),setTimeout(()=>{t.removeChild(s)},300)},3e3)}}class n{constructor(e){this.currentAddress="",this.currentNetwork="1",this.uiManager=e}async initialize(){try{const e=await this.sendMessage({type:"CHECK_WALLET_EXISTS"});e.success?e.exists?(await this.loadAccountInfo(),this.uiManager.showScreen("walletScreen")):this.uiManager.showScreen("welcomeScreen"):this.uiManager.showError("初始化失败: "+e.error)}catch(e){console.error("初始化错误:",e),this.uiManager.showError("初始化失败，请重试")}}async createWallet(e){try{this.uiManager.showMessage("正在创建钱包...");const n=await this.sendMessage({type:"CREATE_WALLET",data:{password:e}});n.success?(this.currentAddress=n.address,this.uiManager.showSuccess("钱包创建成功!"),this.uiManager.showMnemonic(n.mnemonic),await this.loadAccountInfo()):this.uiManager.showError("创建钱包失败: "+n.error)}catch(e){console.error("创建钱包错误:",e),this.uiManager.showError("创建钱包失败，请重试")}}async importWallet(e,n,t){try{this.uiManager.showMessage("正在导入钱包...");const s=await this.sendMessage({type:"IMPORT_WALLET",data:{type:e,value:n,password:t}});s.success?(this.currentAddress=s.address,this.uiManager.showSuccess("钱包导入成功!"),await this.loadAccountInfo(),this.uiManager.showScreen("walletScreen")):this.uiManager.showError("导入钱包失败: "+s.error)}catch(e){console.error("导入钱包错误:",e),this.uiManager.showError("导入钱包失败，请重试")}}async sendTransaction(e,n,t,s){try{if(!e.startsWith("0x")||42!==e.length)return void this.uiManager.showError("无效的接收地址");if(n<=0)return void this.uiManager.showError("金额必须大于0");this.promptForPassword(async o=>{if(!o)return void this.uiManager.showError("需要密码来签名交易");this.uiManager.showMessage("正在发送交易...");const r=await this.sendMessage({type:"SEND_TRANSACTION",data:{to:e,amount:n,gasPrice:t,password:o,asset:s}});r.success?(this.uiManager.showSuccess("交易已发送!"),this.uiManager.showScreen("walletScreen"),setTimeout(()=>this.loadAccountInfo(),1e3)):this.uiManager.showError("发送交易失败: "+r.error)})}catch(e){console.error("发送交易错误:",e),this.uiManager.showError("发送交易失败，请重试")}}async switchNetwork(e){try{if(this.currentNetwork===e)return;this.uiManager.showMessage("正在切换网络...");const n=await this.sendMessage({type:"SWITCH_NETWORK",data:{networkId:e}});n.success?(this.currentNetwork=e,this.uiManager.showSuccess("网络已切换"),await this.loadAccountInfo()):this.uiManager.showError("切换网络失败: "+n.error)}catch(e){console.error("切换网络错误:",e),this.uiManager.showError("切换网络失败，请重试")}}async showReceiveInfo(){this.currentAddress||await this.loadAccountInfo(),this.uiManager.updateReceiveInfo(this.currentAddress)}async loadAccountInfo(){try{const e=await this.sendMessage({type:"GET_ACCOUNT_INFO"});if(e.success){this.currentAddress=e.address,this.currentNetwork=e.networkId,this.uiManager.updateAccountInfo(e.address,e.balance),this.uiManager.updateTokenList(e.tokens||[]);const n=document.getElementById("networkSelect");n&&(n.value=this.currentNetwork)}else console.error("获取账户信息失败:",e.error)}catch(e){console.error("加载账户信息错误:",e)}}promptForPassword(e){const n=document.createElement("div");n.className="modal",n.innerHTML='\n      <div class="modal-content">\n        <h3>请输入密码</h3>\n        <div class="form-group">\n          <input type="password" id="txPassword" placeholder="钱包密码" />\n        </div>\n        <div class="btn-group">\n          <button id="cancelPasswordBtn" class="btn btn-secondary">取消</button>\n          <button id="confirmPasswordBtn" class="btn btn-primary">确认</button>\n        </div>\n      </div>\n    ',document.body.appendChild(n);const t=document.getElementById("txPassword");t&&setTimeout(()=>t.focus(),100);const s=document.getElementById("cancelPasswordBtn");s&&s.addEventListener("click",()=>{document.body.removeChild(n),e(null)});const o=document.getElementById("confirmPasswordBtn");o&&o.addEventListener("click",()=>{const s=t?t.value:"";document.body.removeChild(n),e(s)}),t&&t.addEventListener("keyup",s=>{if("Enter"===s.key){const s=t.value;document.body.removeChild(n),e(s)}})}sendMessage(e){return new Promise((n,t)=>{try{"undefined"!=typeof chrome&&chrome.runtime&&chrome.runtime.sendMessage?chrome.runtime.sendMessage(e,e=>{chrome.runtime.lastError?t(chrome.runtime.lastError):n(e)}):(console.log("模拟环境 - 消息:",e),this.handleMockResponse(e,n,t))}catch(e){t(e)}})}handleMockResponse(e,n,t){setTimeout(()=>{switch(e.type){case"CHECK_WALLET_EXISTS":n({success:!0,exists:!1});break;case"CREATE_WALLET":n({success:!0,address:"0x1234567890123456789012345678901234567890",mnemonic:"abandon abandon abandon abandon abandon abandon abandon abandon abandon abandon abandon about"});break;case"IMPORT_WALLET":n({success:!0,address:"0x9876543210987654321098765432109876543210"});break;case"GET_ACCOUNT_INFO":n({success:!0,address:this.currentAddress||"0x1234567890123456789012345678901234567890",balance:"1.5",network:"ethereum"});break;default:n({success:!1,error:"未知的消息类型"})}},500)}}document.addEventListener("DOMContentLoaded",async()=>{console.log("ShieldWallet 弹出窗口已加载");const t=new e,s=new n(t);await s.initialize(),function(e,n){const t=document.getElementById("createWalletBtn"),s=document.getElementById("importWalletBtn"),o=document.getElementById("createWalletForm"),r=document.getElementById("backFromCreateBtn"),a=document.getElementById("importWalletForm"),c=document.getElementById("backFromImportBtn"),d=document.getElementById("importType"),i=document.getElementById("copyAddressBtn"),l=document.getElementById("sendBtn"),m=document.getElementById("receiveBtn"),u=document.getElementById("historyBtn"),h=document.getElementById("addTokenBtn"),g=document.getElementById("sendForm"),w=document.getElementById("backFromSendBtn"),p=document.getElementById("backFromReceiveBtn"),E=document.getElementById("copyFullAddressBtn"),y=document.getElementById("networkSelect");t&&t.addEventListener("click",()=>{e.showScreen("createWalletScreen")}),s&&s.addEventListener("click",()=>{e.showScreen("importWalletScreen")}),o&&o.addEventListener("submit",async t=>{t.preventDefault();const s=document.getElementById("newPassword").value;s===document.getElementById("confirmPassword").value?await n.createWallet(s):e.showError("两次输入的密码不一致")}),r&&r.addEventListener("click",()=>{e.showScreen("welcomeScreen")}),d&&d.addEventListener("change",()=>{const e=document.getElementById("mnemonicInputGroup"),n=document.getElementById("privateKeyInputGroup");"mnemonic"===d.value?(e?.classList.remove("hidden"),n?.classList.add("hidden")):(e?.classList.add("hidden"),n?.classList.remove("hidden"))}),a&&a.addEventListener("submit",async t=>{t.preventDefault();const s=d.value;let o="";o="mnemonic"===s?document.getElementById("mnemonic").value:document.getElementById("privateKey").value;const r=document.getElementById("importPassword").value;r===document.getElementById("importConfirmPassword").value?await n.importWallet(s,o,r):e.showError("两次输入的密码不一致")}),c&&c.addEventListener("click",()=>{e.showScreen("welcomeScreen")}),i&&i.addEventListener("click",()=>{const n=document.getElementById("accountAddressShort")?.textContent;n&&navigator.clipboard.writeText(n).then(()=>e.showMessage("地址已复制到剪贴板")).catch(e=>console.error("复制失败:",e))}),l&&l.addEventListener("click",()=>{e.showScreen("sendScreen")}),m&&m.addEventListener("click",async()=>{e.showScreen("receiveScreen"),await n.showReceiveInfo()}),u&&u.addEventListener("click",()=>{e.showMessage("交易历史功能即将上线")}),g&&g.addEventListener("submit",async e=>{e.preventDefault();const t=document.getElementById("recipientAddress").value,s=document.getElementById("amount").value,o=document.getElementById("gasPrice").value,r=document.getElementById("assetSelect").value;await n.sendTransaction(t,parseFloat(s),parseInt(o),r)}),w&&w.addEventListener("click",()=>{e.showScreen("walletScreen")}),p&&p.addEventListener("click",()=>{e.showScreen("walletScreen")}),E&&E.addEventListener("click",()=>{const n=document.getElementById("fullAddress")?.textContent;n&&navigator.clipboard.writeText(n).then(()=>e.showMessage("地址已复制到剪贴板")).catch(e=>console.error("复制失败:",e))}),y&&y.addEventListener("change",async()=>{const e=y.value;await n.switchNetwork(e)}),h&&h.addEventListener("click",()=>{e.showMessage("添加代币功能即将上线")})}(t,s)})})();